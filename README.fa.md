Hesabpak — راهنمای اجرا (محلی)

این مخزن شامل بک‌اند (FastAPI) و یک اسکِلفولد برای فرانت‌اند است. این فایل راهنمای سریع برای راه‌اندازی محلی، اجرای تست‌ها، ایجاد بکاپ و کارهای مرتبط را فراهم می‌کند.

پیش‌نیازها
- Python 3.11
- Node.js 20+ (در صورت اجرای فرانت‌اند)
- PostgreSQL (برای محیط تولید یا local) یا استفاده از SQLite برای توسعه

تنظیمات محیطی
1. کپی فایل `.env.example` به `.env` و مقداردهی متغیرها (به‌خصوص `DATABASE_URL` و `SECRET_KEY`).
2. اگر می‌خواهید فیلدهای حساس رمزنگاری شوند، یک Fernet key تولید کنید و در `DATABASE_ENCRYPTION_KEY` قرار دهید. مثال تولید کلید Fernet با یک اسکریپت پایتون.

اجرای محلی (بک‌اند)
1. نصب dependencies:

    cd backend
    python -m pip install -r requirements.txt

2. تنظیم پایگاه داده:
- برای توسعه ساده می‌توانید از SQLite استفاده کنید (تنظیم `DATABASE_URL` به `sqlite:///./dev.db`).
- برای PostgreSQL، مقدار `DATABASE_URL` را به شکل `postgresql://user:pass@host:port/dbname` تنظیم کنید.

3. اجرای مهاجرت‌ها:

    alembic upgrade head

4. اجرای برنامه:

    uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

اجرای نسخهٔ دموی Docker (با دیتای نمونه)

اگر می‌خواهید نسخهٔ دِمو با دیتای آماده را اجرا کنید، از فایل compose مخصوص دِمو استفاده کنید:

```bash
docker compose -f docker-compose.demo.yml up --build
```

پرچم `DEMO_SEED=true` در فایل compose باعث می‌شود که پس از اجرای مهاجرت‌ها، اسکریپت دِمو اجرا و داده‌های نمونه بار شود (10 کالا، 10 مشتری، 10 فاکتور و تعدادی پرداخت). فایل marker برای جلوگیری از اجرای مجدد در `/app/.seed_done` قرار می‌گیرد.

بکاپ‌ها
- مسیر ذخیرهٔ بکاپ‌های JSON: `backend/backups/`.
- ایجاد بکاپ دستی: POST `/api/backups/manual` (نیاز به توکن Admin).
- دانلود بکاپ: GET `/api/backups/{id}/download`.

نکتهٔ مهم دربارهٔ بکاپ قابل اتکا: برای محیط تولید از ابزارهای سطح دیتابیس مانند pg_dump استفاده کنید تا دیتابیس کامل (جداول، ایندکس، sequences) را ذخیره کنید. مثال‌ها در مستندات داخلی قابل افزودن هستند.

سال مالی
- ایجاد سال مالی: POST `/api/financial-years` (Admin)
- بستن سال مالی: POST `/api/financial-years/{id}/close` — این endpoint اسناد بسته‌شدن را می‌سازد و مانده‌ها را به `RetainedEarnings` منتقل می‌کند (پیاده‌سازی ساده؛ برای محیط حقیقی لازم است حسابرسی و بررسی حسابداری شود).

تست‌ها
- اجرای تست‌های واحد (pytest):

    cd backend
    pytest -q

عملکرد و کش
- قیمت‌های ارزی و ویجت‌های مشابه به صورت محلی با TTL کش می‌شوند (در حافظه). برای استقرار استفاده از Redis پیشنهاد می‌شود.

گیت‌هاب اکشن (CI)
- یک workflow برای اجرای تست‌های پایتون اضافه شده است — فایل در `.github/workflows/ci.yml` قرار دارد.

سیاست امنیتی (خلاصه)
- توصیه می‌شود کلیدهای محرمانه را در Vault/Secrets Manager نگه دارید.
- دسترسی فولدر بکاپ باید محدود شود و بکاپ‌ها خارج از روت سرویس قرار گیرند.
- برای محیط تولید از HTTPS، headers امن (CSP, HSTS) و rate-limiting استفاده کنید.

درخواست‌های بعدی پیشنهادی:
- افزودن pg_dump-based backup و restore script؛
- مهاجرت کش به Redis و ایجاد worker برای revalidation؛
- ساخت UI مدیریت بکاپ و سال مالی؛
- افزودن تست‌های e2e با Cypress.
